name: Cleanup Preview Environment

on:
  pull_request:
    types: [closed] # PRãŒé–‰ã˜ã‚‰ã‚ŒãŸï¼ˆãƒãƒ¼ã‚¸ã¾ãŸã¯ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸï¼‰ã¨ãã«å®Ÿè¡Œ

env:
  GCP_PROJECT_ID: "akkie-dev"
  REGION: "asia-northeast1"
  # Workload Identity ã®è¨­å®šå€¤ï¼ˆå‰å›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨å…±é€šï¼‰
  WORKLOAD_IDENTITY_PROVIDER: "projects/838262913247/locations/global/workloadIdentityPools/runway-github-pool/providers/runway-github-provider"
  SERVICE_ACCOUNT: "runway-github-actions-sa@akkie-dev.iam.gserviceaccount.com"

jobs:
  cleanup:
    runs-on: ubuntu-latest

    # Cloud Run ã®å‰Šé™¤ã¨ PR ã‚³ãƒ¡ãƒ³ãƒˆã®ãŸã‚ã«æ¨©é™ã‚’è¨­å®š
    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: 'write' # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Google Cloud èªè¨¼
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      # 2. Cloud Run ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤
      - name: 'Delete Cloud Run Service'
        id: delete
        # ã‚µãƒ¼ãƒ“ã‚¹åã¯å‰å›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§ä½¿ã£ãŸ 'pr-<PRç•ªå·>' ã¨ä¸€è‡´ã•ã›ã‚‹
        run: |
          SERVICE_NAME="pr-${{ github.event.number }}"
          echo "Attempting to delete Cloud Run service: $SERVICE_NAME"
          
          # ã‚µãƒ¼ãƒ“ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€å­˜åœ¨ã™ã‚Œã°å‰Šé™¤ã™ã‚‹
          # '--quiet' ã§ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã€'--format=disable'ã§æˆåŠŸæ™‚ã®å‡ºåŠ›ã‚’æŠ‘åˆ¶
          gcloud run services delete $SERVICE_NAME \
            --region=${{ env.REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --quiet || echo "Service $SERVICE_NAME not found or already deleted."

      # 3. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å‰Šé™¤å®Œäº†ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: 'Add Cleanup Complete Comment'
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const message = `ğŸ—‘ï¸ **Preview environment has been cleaned up.**\n\nCloud Run service \`pr-${prNumber}\` has been deleted.`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });