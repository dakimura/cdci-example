name: Preview Deployment on Pull Request

on:
  pull_request:
    types: [opened, synchronize] # PRã‚ªãƒ¼ãƒ—ãƒ³æ™‚ã¨ã€æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚

env:
  GCP_PROJECT_ID: "akkie-dev"
  REGION: "asia-northeast1" # æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®å ´åˆã€‚è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„
  REPOSITORY: "runway-docker-repo" # äº‹å‰ã«ä½œæˆã—ãŸ Artifact Registry ã®ãƒªãƒã‚¸ãƒˆãƒªå
  IMAGE_NAME: "example-app"
  # å…ˆã»ã© gcloud ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã—ãŸ Provider ID
  WORKLOAD_IDENTITY_PROVIDER: "projects/838262913247/locations/global/workloadIdentityPools/runway-github-pool/providers/runway-github-provider"
  SERVICE_ACCOUNT: "runway-github-actions-sa@akkie-dev.iam.gserviceaccount.com"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # Workload Identity ã‚’ä½¿ã†ãŸã‚ã«å¿…é ˆã®æ¨©é™è¨­å®š
    # Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ PR ã‚³ãƒ¡ãƒ³ãƒˆã®ãŸã‚ã«æ¨©é™ã‚’è¨­å®š
    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: 'write' # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Google Cloud èªè¨¼
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      # 2. Docker ã‚’ Artifact Registry ã«å¯¾ã—ã¦èªè¨¼
      - name: 'Docker Auth'
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # 3. Docker Build & Push
      - name: 'Build and Push Container'
        run: | # PR ã® head_sha ã‚’ã‚¿ã‚°ã«ä½¿ç”¨. å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ã†ãŸã‚ã« IMAGE_TAG ã‚’å‡ºåŠ›
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.event.pull_request.head.sha }}"
          echo "Building image with tag: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" .
          docker push "$IMAGE_TAG"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT

      # 4. Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: 'Deploy to Cloud Run'
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: pr-${{ github.event.number }} # ã‚µãƒ¼ãƒ“ã‚¹åã‚’ pr-<PRç•ªå·> ã¨ã™ã‚‹
          region: ${{ env.REGION }}
          image: ${{ steps.build.outputs.IMAGE_TAG }}
          # ğŸš¨ å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹è¨­å®šã€‚å¿…è¦ã«å¿œã˜ã¦ `--no-allow-unauthenticated` ã«å¤‰æ›´
          flags: '--allow-unauthenticated'

      # 5. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« URL ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: 'Add Preview URL to PR Comment'
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const serviceUrl = '${{ steps.deploy.outputs.url }}';
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `**Preview URL** \n\n**Service Name:** \`pr-${prNumber}\`\n**URL:** ${serviceUrl}`
            });