name: Production Deployment on Main Merge

on:
  push:
    branches: [ "main" ] # mainブランチへのpush/merge時に実行

env:
  GCP_PROJECT_ID: "akkie-dev"
  REGION: "asia-northeast1"
  REPOSITORY: "my-docker-repo"
  IMAGE_NAME: "example-app"
  # 本番環境のサービス名 (任意の名前に変更可)
  PROD_SERVICE_NAME: "prod-example-app"
  # Workload Identity の設定値
  WORKLOAD_IDENTITY_PROVIDER: "projects/838262913247/locations/global/workloadIdentityPools/runway-github-pool/providers/runway-github-provider"
  SERVICE_ACCOUNT: "runway-github-actions-sa@akkie-dev.iam.gserviceaccount.com"

jobs:
  build-and-deploy-prod:
    runs-on: ubuntu-latest

    # Workload Identity を使うために必須の権限設定
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Google Cloud 認証
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      # 2. Docker を Artifact Registry に対して認証
      - name: 'Docker Auth'
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # 3. Docker Build & Push
      - name: 'Build and Push Container'
        id: build
        # mainブランチではコミットSHAと'latest'タグの両方を使うのが一般的. 両方のタグをPush -> デプロイで使用するタグをLATEST_TAGに設定
        run: |
          COMMIT_SHA_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          LATEST_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "Building image with tags: $COMMIT_SHA_TAG, $LATEST_TAG"
          
          docker build -t "$COMMIT_SHA_TAG" -t "$LATEST_TAG" ./projects/${{env.pro
          
          docker push "$COMMIT_SHA_TAG"
          docker push "$LATEST_TAG"
          
          echo "IMAGE_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT

      # 4. Cloud Run 本番サービスにデプロイ
      - name: 'Deploy to Cloud Run Production'
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.PROD_SERVICE_NAME }} # 本番環境の固定サービス名
          region: ${{ env.REGION }}
          image: ${{ steps.build.outputs.IMAGE_TAG }} # latestタグのイメージを使用
          # 本番環境なので、必要に応じて --no-allow-unauthenticated (認証必須) に変更してください
          flags: '--allow-unauthenticated'

      # 5. デプロイ完了メッセージ
      - name: 'Deployment Complete'
        # デプロイされたURLを確認したい場合は、以下のgcloud run services describeコマンドを使用します
        run: | 
          echo "✅ Cloud Run Production Service ${{ env.PROD_SERVICE_NAME }} deployed successfully!"
          gcloud run services describe ${{ env.PROD_SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)'