name: Production Deployment on Main Merge

on:
  push:
    branches: [ "main" ] # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®push/mergeæ™‚ã«å®Ÿè¡Œ

env:
  GCP_PROJECT_ID: "akkie-dev"
  REGION: "asia-northeast1"
  REPOSITORY: "runway-docker-repo"
  SERVICE_NAME: "example-app"
  # Workload Identity ã®è¨­å®šå€¤
  WORKLOAD_IDENTITY_PROVIDER: "projects/838262913247/locations/global/workloadIdentityPools/runway-github-pool/providers/runway-github-provider"
  SERVICE_ACCOUNT: "runway-github-actions-sa@akkie-dev.iam.gserviceaccount.com"

jobs:
  build-and-deploy-prod:
    runs-on: ubuntu-latest

    # Workload Identity ã‚’ä½¿ã†ãŸã‚ã«å¿…é ˆã®æ¨©é™è¨­å®š
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Google Cloud èªè¨¼
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      # 2. Docker ã‚’ Artifact Registry ã«å¯¾ã—ã¦èªè¨¼
      - name: 'Docker Auth'
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # 3. Docker Build & Push
      - name: 'Build and Push Container'
        id: build
        # mainãƒ–ãƒ©ãƒ³ãƒã§ã¯ã‚³ãƒŸãƒƒãƒˆSHAã¨'latest'ã‚¿ã‚°ã®ä¸¡æ–¹ã‚’ä½¿ã†ã®ãŒä¸€èˆ¬çš„. ä¸¡æ–¹ã®ã‚¿ã‚°ã‚’Push -> ãƒ‡ãƒ—ãƒ­ã‚¤ã§ä½¿ç”¨ã™ã‚‹ã‚¿ã‚°ã‚’LATEST_TAGã«è¨­å®š
        run: |
          COMMIT_SHA_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          LATEST_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:latest"
          
          echo "Building image with tags: $COMMIT_SHA_TAG, $LATEST_TAG"
          
          docker build -t "$COMMIT_SHA_TAG" -t "$LATEST_TAG" ./projects/${{env.SERVICE_NAME}}/
          
          docker push "$COMMIT_SHA_TAG"
          docker push "$LATEST_TAG"
          
          echo "IMAGE_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT

      # 4. Cloud Run æœ¬ç•ªã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: 'Deploy to Cloud Run Production'
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }} # æœ¬ç•ªç’°å¢ƒã®å›ºå®šã‚µãƒ¼ãƒ“ã‚¹å
          region: ${{ env.REGION }}
          image: ${{ steps.build.outputs.IMAGE_TAG }} # latestã‚¿ã‚°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨
          # ğŸš¨ å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹è¨­å®šã€‚å¿…è¦ã«å¿œã˜ã¦ `--no-allow-unauthenticated` ã«å¤‰æ›´
          flags: |
            --allow-unauthenticated
            --service-account=example-app@akkie-dev.iam.gserviceaccount.com

      # 5. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      - name: 'Deployment Complete'
        # ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸURLã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®gcloud run services describeã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™
        run: | 
          echo "âœ… Cloud Run Production Service ${{ env.SERVICE_NAME }} deployed successfully!"
          gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)'